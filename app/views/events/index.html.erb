<% view = params[:view] || 'grid' %>

<div class="wrapper">
  <% if TeSS::Config.solr_enabled %>
    <div id="sidebar" class="popout-sidebar">
      <%= render partial: "search/common/facet_sidebar", locals:  { resources: @events_results, resource_type: Event } %>
    </div>
  <% end %>

  <div id="content">
    <%= search_and_facet_params.inspect %>
    <%= controller.default_url_options %>
    <%= url_for search_and_facet_params %>
    <%= url_for({ fish: true }) %>
    <%= url_for search_and_facet_params.to_unsafe_h %>
    <%= url_for "?" + search_and_facet_params.to_query %>
    <%= url_for "?fish=true" %>
    <%= url_for({ anchor: 'ye' }) %>
    <% if TeSS::Config.solr_enabled %>
      <div class="row">
        <% if policy(:event).create? %>
          <%= link_to new_event_path, class: 'btn btn-primary' do %>
            <i class="fa fa-plus-square"></i> Register event
          <% end %>
        <% end %>
        <%= render partial: 'subscriptions/subscribe_button', locals: { type: 'Event' } %>
        <div class="pull-right">
          <%= info_button('What are events in TeSS?') do %>
            <%= render_markdown(EventsHelper::EVENTS_INFO) %>
          <% end %>
        </div>
      </div>
      <div class="row">
        <%= render partial: "search/common/search_box", locals: { resource_path: events_path } %>
        <button class="btn btn-default" id="sidebar-toggle" type="button" autocomplete="off">
          <i class="fa fa-filter"></i> Filters
        </button>
        <% include_expired = @facet_params.delete('include_expired') %>
        <% if include_expired %>
          <% button_params = search_and_facet_params %>
          <% button_params.delete(:include_expired) %>
          <% button_text = "Hide" %>
        <% else %>
          <% button_text = "Show" %>
          <% button_params = search_and_facet_params.merge(include_expired: true) %>
        <% end %>
        <%= link_to button_params, class: 'btn btn-default' do %>
          <i class="fa fa-hourglass-end"></i> <%= button_text %> past events
        <% end %>
      </div>
      <div class="row">
        <%= render partial: "search/common/search_info", locals: { resources: @events_results, resource_type: 'event' } %>
        <%= render partial: "search/common/search_filters", locals: { resources: @events_results } %>
      </div>
    <% end %>

    <ul class="nav nav-tabs">
      <%= content_tag(:li, class: (view == 'grid' ? 'active' : '')) do %>
        <%= link_to events_path(search_and_facet_params) do %>
          <i class="fa fa-table"></i> Grid
        <% end %>
      <% end %>
      <%= content_tag(:li, class: (view == 'map' ? 'active' : '')) do %>
        <%= link_to map_events_path(search_and_facet_params) do %>
          <i class="fa fa-globe"></i> Map
        <% end %>
      <% end %>
      <%= content_tag(:li, class: (view == 'calendar' ? 'active' : '')) do %>
        <%= link_to calendar_events_path(search_and_facet_params) do %>
          <i class="fa fa-calendar"></i> Calendar
        <% end %>
      <% end %>
    </ul>

    <div class="tab-content">
      <% if view == 'grid' %>
        <%= render :partial => "events/partials/events_grid", locals: {events: @events} %>
      <% elsif view == 'map' %>
        <%= render :partial => "events/partials/events_map", locals: { events: @events} %>
      <% elsif view == 'calendar' %>
        <%= render partial: "events/partials/events_calendar", locals: { events: @events} %>
      <% end %>
    </div>
  </div>
</div>
